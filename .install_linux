#!/usr/bin/env bash

function pkgmgr_install() {

	local installer="yum"
	if lsb_release -d | grep -i ubuntu &> /dev/null ; then
		installer="apt"
	fi

	if [ ! -z $1 ]; then
		python_version="$1"
	fi

	local pkg
	local pkgs
	local package_ext=`arch`
	for pkg in $@; do
		if [ "$installer" = "apt" ]; then
			pkgs+=("$pkg")
	else
			pkgs+=("$pkg$package_ext")
		fi
	done
	pkgs=`printf "%s " "${pkgs[@]}"`
	sudo $installer install -y $pkgs
}

function pkgmgr_install_python_src() {

	# Set the python package version
	if [ ! -z $1 ]; then
		local python_version="$1"
	else
		local python_version="2.7.12"
	fi

	# Set the install directory
	if [ ! -z $2 ]; then
		local install_prefix="--prefix=$2"
	else
		local install_prefix=""
	fi

	local package_dir="$USER/Downloads/package"

	# Install dependencies
	if lsb_release -d | grep -i ubuntu &> /dev/null ; then
		`pkgmgr_install libzzip-dev libssl-dev libreadline-dev libsqlite3-dev build-essential`
	else
		`pkgmgr_install zlib-devel openssl-devel readline-devel sqlite-devel gcc-c++`
	fi

	
	# Setup environment
	mkdir -p $package_dir

	# Downlaod Requirements
	wget https://bootstrap.pypa.io/get-pip.py --directory-prefix=$package_dir
	wget http://www.python.org/ftp/python/$python_version/Python-$python_version.tgz --directory-prefix=$package_dir

	# Extract
	tar zxf $package_dir/Python-$python_version.tgz -C $package_dir

	# Install
	## Python
	$package_dir/Python-$python_version/configure $install_prefix
	make $package_dir/Python-$python_version
	if [ "$install_prefix" = "" ]; then
		echo "Running with sudo"
		sudo make install $package_dir/Python-$python_version
		## Pip
		sudo python $package_dir/get-pip.py
	else
		make install $package_dir/Python-$python_version
		## Pip
		python $package_dir/get-pip.py
	fi


	# Cleanup
	rm -fr $package_dir/get-pip.py
	rm $package_dir/Python-$python_version.tgz
	rm -fr $package_dir/Python-$python_version

	unset package_dir
	unset install_prefix
	unset python_version
}
